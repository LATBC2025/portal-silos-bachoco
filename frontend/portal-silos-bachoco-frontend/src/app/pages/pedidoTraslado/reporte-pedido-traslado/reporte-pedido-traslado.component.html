<div class="container-home">
  <app-header class="fade-in component-header"></app-header>
</div>
<mat-card class="main-card">
  <mat-card-content>
    <div class="card-header">
      <h4 class="mb-0" class="text-title" style="text-align: center;">Gestión de Pedido Traslado</h4>
    </div>
    <form [formGroup]="formPedidoTraslado">
      <div class="row mb-3">
        <div class="col-md-2">
          <label for="silo" class="form-label">Silo</label>
          <select class="form-select" formControlName="silo" id="silo">
            <option value="0">Seleccionar</option>
            @for(item of listSilo;track item.id){
            <option [value]="item.id">{{item.nombre}}</option>
            }
          </select>
          <div class="text-danger size-text-error">
            @if (formPedidoTraslado.get('silo')?.invalid && formPedidoTraslado.get('silo')?.touched) {
            @if (formPedidoTraslado.get('silo')?.errors?.['required']) {
            Campo requerido.
            }
            @if (formPedidoTraslado.get('silo')?.errors?.['zeroValue']) {
            Campo requerido.
            }
            }
          </div>
        </div>
        <div class="col-md-3">
          <label for="material" class="form-label">Material</label>
          <select class="form-select" formControlName="material" id="material">
            <option value="0">Seleccionar</option>
            @for(item of listMateriales;track item.id){
            <option [value]="item.id">{{item.descripcion}}</option>
            }
          </select>
          <div class="text-danger size-text-error">
            @if (formPedidoTraslado.get('material')?.invalid && formPedidoTraslado.get('material')?.touched) {
            @if (formPedidoTraslado.get('material')?.errors?.['required']) {
            Campo requerido.
            }
            @if (formPedidoTraslado.get('material')?.errors?.['zeroValue']) {
            Campo requerido.
            }
            }
          </div>
        </div>
        <div class="col-md-3">
          <label for="fechaInicio" class="form-label">Fecha Inicio</label>
          <input type="date" class="form-control" formControlName="fechaInicio" id="fechaInicio">
          <div class="text-danger size-text-error">
            @if (formPedidoTraslado.get('fechaInicio')?.invalid && formPedidoTraslado.get('fechaInicio')?.touched) {
            @if (formPedidoTraslado.get('fechaInicio')?.errors?.['required']) {
            Campo requerido.
            }
            }
          </div>
        </div>
        <div class="col-md-3">
          <label for="fechaFin" class="form-label">Fecha Fin</label>
          <input type="date" class="form-control" formControlName="fechaFin" id="fechaFin">
          <div class="text-danger size-text-error">
            @if (formPedidoTraslado.get('fechaFin')?.invalid && formPedidoTraslado.get('fechaFin')?.touched) {
            @if (formPedidoTraslado.get('fechaF')?.errors?.['required']) {
            Campo requerido.
            }
            @else if (formPedidoTraslado.get('fechaFin')?.errors?.['rangoFechaInvalido']) {
            Campo fecha fin no debe ser menor a fecha inicio.
            }
            }
          </div>
        </div>
      </div>
    </form>

    <div class="row mb-3">
      <div class="col-md-1">
        <button class="btn-custom" (click)="findAllPedidosTraslado()">Buscar</button>
      </div>
      <!--BOTON PARA GENERAR REPORTE DE EXCEL-->
      <div class="col-md-2">
    <button
      class="btn-custom"
      type="button"
      (click)="exportar()"
      [disabled]="!listaPedidoTrasladoRequestFilter?.length || exportando"
      [title]="!listaPedidoTrasladoRequestFilter?.length ? 'Primero realiza una búsqueda' : 'Exportar resultados'">
      {{ exportando ? 'Exportando...' : 'Exportar' }}
    </button>
  </div>

    </div>

<!--  Mensaje informativo (saldo se libera mañana) -->
    @if (showSaldoInfo) {
      <div class="alert alert-info mt-2" role="alert">
        ℹ️ Algunos pedidos tienen confirmaciones del día de hoy.
        El saldo para reprogramación se libera a partir de mañana.
      </div>
    }


    <div class="scroll-lista">
      <table class="table table-striped" style="min-width: 2500px;">
        <thead>
          <tr>
            <th scope="col">Id</th>
            <th scope="col">Planta Destino</th>
            <th scope="col">Pedido Traslado</th>
            <th scope="col">Cantidad pedido</th>
            <th scope="col">Cantidad Traslado</th>
            <!--  NUEVAS COLUMNAS PARA LIBERAR SALDO -->
            <th scope="col">Cantidad Programada</th>
            <th scope="col">Cantidad Pendiente por Programar</th>

            <th scope="col">Cantidad Recibida</th>
            <th scope="col">Cantidad Pendiente Traslado</th>
            <th scope="col">Pedido Compras Asociado</th>
            <th scope="col">Número Proveedor</th>
            <th scope="col">Traslado Pendiente Facturas</th>
          </tr>
        </thead>
        <tbody>
          @for (pedidoTraslado of listaPedidoTrasladoRequestFilter; track pedidoTraslado.pedidoTrasladoId) {
          <tr>
            <td>{{ pedidoTraslado.pedidoTrasladoId | number }}</td>
            <td>{{ pedidoTraslado.nombrePlantaDestino }}</td>
            <td>{{ pedidoTraslado.numPedidoTraslado }}</td>
            <td>{{ pedidoTraslado.cantidadPedido }}</td>
            <td>{{ pedidoTraslado.cantidadTraslado }}</td>
            <!-- ✅ NUEVAS COLUMNAS -->
              <td>{{ (pedidoTraslado.cantidadEmbarcadaReal ?? 0) | number:'1.0-0' }}</td>
              <td>{{ (pedidoTraslado.cantidadPendientePorProgramar ?? 0) | number:'1.0-0' }}</td>

            <td>{{ pedidoTraslado.cantidadRecibidaPa }}</td>
            <td>{{ pedidoTraslado.cantidadPendienteTraslado }}</td>
            <td>{{ pedidoTraslado.numCompraAsociado }}</td>
            <td>{{ pedidoTraslado.numeroProveedor ?? '-' }}</td>
            <td>{{ pedidoTraslado.trasladosPendFact }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between p-2">
      <ngb-pagination [collectionSize]="collectionSize" [(page)]="page" [pageSize]="pageSize"
        (pageChange)="refreshPedidos()">
      </ngb-pagination>

      <select class="form-select" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="refreshPedidos()">
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
        <option [ngValue]="50">50</option>
        <option [ngValue]="100">100</option>
      </select>
    </div>
  </mat-card-content>
</mat-card>
